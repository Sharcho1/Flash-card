<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Legendary V3.1 (Flip Toggle)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1903/1903162.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* 3D Flip Effects */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .rotate-y-0 { transform: rotateY(0deg); }
        .no-tap-highlight { -webkit-tap-highlight-color: transparent; }
        
        /* Smooth Transitions */
        .screen { transition: opacity 0.3s ease-in-out; }
        #card-inner { transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1); }
    </style>
</head>
<body class="bg-gray-900 h-screen flex flex-col text-white font-sans overflow-hidden select-none">

    <header class="px-5 py-4 bg-gray-800 shadow-md flex justify-between items-center z-10 border-b border-gray-700">
        <div class="flex items-center gap-3">
            <button id="btn-back" onclick="goToLibrary()" class="hidden text-gray-400 hover:text-white active:scale-90 transition-transform"><i class="fas fa-arrow-left text-xl"></i></button>
            <div>
                <h1 class="text-lg font-bold text-indigo-400" id="header-title">Legendary Library</h1>
                <p id="header-subtitle" class="text-[10px] text-gray-500">V3.1 Flip Toggle</p>
            </div>
        </div>
        <button onclick="resetAllData()" class="text-gray-600 text-xs hover:text-red-500 p-2"><i class="fas fa-trash"></i></button>
    </header>

    <main id="app-container" class="flex-1 relative w-full max-w-lg mx-auto overflow-hidden">
        
        <div id="screen-library" class="screen absolute inset-0 p-5 flex flex-col overflow-y-auto">
            <div class="flex justify-between items-end mb-4">
                <h2 class="text-xl font-bold text-gray-200">‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏°‡∏∏‡∏î‡∏à‡∏î üìö</h2>
                <button onclick="createNewDeck()" class="text-xs bg-indigo-600 px-3 py-1.5 rounded-lg hover:bg-indigo-500 shadow-lg border border-indigo-500">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            
            <div id="deck-list" class="grid grid-cols-1 gap-3 pb-20">
                </div>

            <div id="library-empty" class="hidden flex-col items-center justify-center mt-20 text-gray-500">
                <i class="fas fa-folder-plus text-5xl mb-4 opacity-30"></i>
                <p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á Deck ‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏¢!</p>
            </div>
        </div>

        <div id="screen-dashboard" class="screen absolute inset-0 flex flex-col items-center justify-center p-6 space-y-6 hidden bg-gray-900">
            <div class="text-center space-y-2">
                <div class="inline-block p-5 rounded-full bg-gray-800 shadow-2xl mb-2 relative border border-gray-700">
                    <i class="fas fa-layer-group text-5xl text-indigo-500"></i>
                    <span id="dash-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-6 h-6 flex items-center justify-center rounded-full hidden border-2 border-gray-900">0</span>
                </div>
                <h2 id="dash-title" class="text-3xl font-bold text-gray-100">Deck Name</h2>
                <p id="dash-stats" class="text-gray-400 text-sm">...</p>
            </div>

            <button onclick="startSession()" id="btn-play" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-4 rounded-2xl shadow-xl text-xl font-bold transition transform active:scale-95 flex items-center justify-center gap-2 opacity-50 pointer-events-none border-b-4 border-indigo-800">
                <i class="fas fa-play"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô
            </button>

            <div class="w-full border-t border-gray-700 pt-4 mt-2 grid grid-cols-2 gap-3">
                <button onclick="triggerImport()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 py-3 rounded-xl border border-gray-700 text-sm font-semibold flex flex-col items-center gap-1 active:scale-95 transition">
                    <i class="fas fa-file-csv text-green-400 text-lg"></i> <span>Import CSV</span>
                </button>
                <button onclick="openPasteModal()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 py-3 rounded-xl border border-gray-700 text-sm font-semibold flex flex-col items-center gap-1 active:scale-95 transition">
                    <i class="fas fa-paste text-yellow-400 text-lg"></i> <span>Auto Paste</span>
                </button>
                <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleCSV(this)">
            </div>
            
            <button onclick="deleteCurrentDeck()" class="text-red-900/40 text-xs mt-6 hover:text-red-500 transition-colors">‡∏•‡∏ö Deck ‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£</button>
        </div>

        <div id="screen-study" class="screen absolute inset-0 flex flex-col p-6 hidden bg-gray-900 z-20">
            <div class="flex justify-between text-xs text-gray-400 mb-2 font-mono">
                <span><i class="fas fa-inbox mr-1"></i>REMAIN: <span id="queue-remain" class="text-white">0</span></span>
                <span><i class="fas fa-fire mr-1 text-orange-500"></i>STREAK: <span id="card-streak" class="text-white">0</span></span>
            </div>
            
            <div class="w-full bg-gray-700 h-1.5 rounded-full mb-6 overflow-hidden">
                <div id="progress-bar" class="bg-indigo-500 h-full w-0 transition-all duration-300 shadow-[0_0_10px_rgba(99,102,241,0.5)]"></div>
            </div>

            <div class="flex-1 relative perspective-1000 group cursor-pointer no-tap-highlight" onclick="toggleFlip()">
                <div id="card-inner" class="relative w-full h-full text-center transform-style-3d shadow-2xl rounded-3xl">
                    
                    <div class="absolute inset-0 w-full h-full bg-gray-800 rounded-3xl border border-gray-600 flex flex-col items-center justify-center p-6 backface-hidden shadow-black/60 shadow-xl">
                        <span class="text-[10px] text-indigo-400 uppercase tracking-[0.2em] mb-4 bg-indigo-900/30 px-3 py-1 rounded-full">Question</span>
                        <div class="overflow-y-auto max-h-[60vh] w-full flex flex-col items-center justify-center">
                             <h2 id="card-front" class="text-2xl md:text-3xl font-bold text-white leading-relaxed break-words">Loading...</h2>
                        </div>
                        <p class="text-gray-600 text-[10px] mt-6 absolute bottom-6 flex items-center gap-2">
                            <i class="fas fa-hand-pointer animate-bounce"></i> ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢
                        </p>
                    </div>

                    <div class="absolute inset-0 w-full h-full bg-indigo-900 rounded-3xl border border-indigo-600 flex flex-col items-center justify-center p-6 backface-hidden rotate-y-180 shadow-black/60 shadow-xl">
                        <span class="text-[10px] text-indigo-200 uppercase tracking-[0.2em] mb-4 bg-indigo-800/50 px-3 py-1 rounded-full">Answer</span>
                        <div class="overflow-y-auto max-h-[60vh] w-full flex flex-col items-center justify-center">
                            <h2 id="card-back" class="text-2xl md:text-3xl font-bold text-white leading-relaxed break-words">Answer</h2>
                        </div>
                        <p class="text-indigo-400/40 text-[10px] mt-6 absolute bottom-6">
                            ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                        </p>
                    </div>
                </div>
            </div>

            <div id="controls" class="mt-6 grid grid-cols-4 gap-2 opacity-0 pointer-events-none transition-all duration-300 transform translate-y-4">
                <button onclick="rateCard(1); event.stopPropagation();" class="bg-red-900/30 border border-red-500/30 text-red-200 py-3 rounded-xl font-bold text-xs active:bg-red-800 active:scale-95 transition-all hover:bg-red-900/50">Again<br><span id="lbl-1" class="text-[9px] opacity-70 font-normal">1m</span></button>
                <button onclick="rateCard(2); event.stopPropagation();" class="bg-yellow-900/30 border border-yellow-500/30 text-yellow-200 py-3 rounded-xl font-bold text-xs active:bg-yellow-800 active:scale-95 transition-all hover:bg-yellow-900/50">Hard<br><span id="lbl-2" class="text-[9px] opacity-70 font-normal">2d</span></button>
                <button onclick="rateCard(3); event.stopPropagation();" class="bg-green-900/30 border border-green-500/30 text-green-200 py-3 rounded-xl font-bold text-xs active:bg-green-800 active:scale-95 transition-all hover:bg-green-900/50">Good<br><span id="lbl-3" class="text-[9px] opacity-70 font-normal">3d</span></button>
                <button onclick="rateCard(4); event.stopPropagation();" class="bg-blue-900/30 border border-blue-500/30 text-blue-200 py-3 rounded-xl font-bold text-xs active:bg-blue-800 active:scale-95 transition-all hover:bg-blue-900/50">Easy<br><span id="lbl-4" class="text-[9px] opacity-70 font-normal">4d</span></button>
            </div>
        </div>
        
        <div id="screen-finished" class="screen absolute inset-0 flex flex-col items-center justify-center p-6 hidden text-center bg-gray-900 z-30">
             <div class="w-24 h-24 bg-green-500/20 rounded-full flex items-center justify-center mb-6 animate-pulse">
                <i class="fas fa-check text-5xl text-green-400"></i>
             </div>
             <h2 class="text-3xl font-bold text-white mb-2">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!</h2>
             <p class="text-gray-400 text-sm">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏°‡∏≤‡∏Å ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏ô‡∏∞</p>
             <button onclick="closeDashboard()" class="mt-10 bg-gray-800 hover:bg-gray-700 px-8 py-3 rounded-full text-white border border-gray-600 transition shadow-lg">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏°</button>
        </div>

        <div id="paste-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-gray-800 w-full max-w-lg rounded-2xl border border-gray-600 p-0 overflow-hidden shadow-2xl">
                <div class="p-4 bg-gray-900 border-b border-gray-700 flex justify-between items-center">
                    <span class="text-white font-bold"><i class="fas fa-magic text-yellow-400 mr-2"></i>‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Auto-Detect)</span>
                    <button onclick="document.getElementById('paste-modal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-4">
                    <p class="text-[10px] text-gray-400 mb-2">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: Excel (Tab), "Question : Answer", "Front - Back"</p>
                    <textarea id="paste-area" class="w-full h-48 bg-gray-900 text-white p-3 rounded-lg text-sm border border-gray-700 focus:border-indigo-500 focus:outline-none resize-none" placeholder="‡∏ß‡∏≤‡∏á‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                    <button onclick="processPaste()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold mt-4 shadow-lg transition">‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Flashcard ‚ö°</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- 1. CORE & CONFIG (V3.1) ---
        let library = JSON.parse(localStorage.getItem('legendaryLibrary')) || [];
        let activeDeckId = null; 
        
        // Session State
        let sessionQueue = [];
        let currentCard = null;
        let isFlipped = false;
        
        // Algorithm Settings (Modified SM-2)
        const SETTINGS = { 
            LEARNING_STEPS: [1, 10], // minutes
            GRADUATING_INTERVAL: 1,  // day
            EASY_BONUS: 1.3,
            FUZZ_FACTOR: 0.05
        };

        // Initialize
        renderLibrary();

        // --- 2. LIBRARY & UI LOGIC ---
        function renderLibrary() {
            const list = document.getElementById('deck-list');
            list.innerHTML = "";
            
            if(library.length === 0) {
                document.getElementById('library-empty').classList.remove('hidden');
                document.getElementById('deck-list').classList.add('hidden');
            } else {
                document.getElementById('library-empty').classList.add('hidden');
                document.getElementById('deck-list').classList.remove('hidden');
                
                library.forEach(deck => {
                    const now = Date.now();
                    const due = deck.cards.filter(c => c.nextReview <= now).length;
                    
                    const div = document.createElement('div');
                    div.className = "bg-gray-800 p-4 rounded-2xl border border-gray-700 flex justify-between items-center active:scale-95 transition-transform cursor-pointer shadow-md hover:border-gray-600";
                    div.onclick = () => openDeck(deck.id);
                    div.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl ${due > 0 ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30' : 'bg-gray-700 text-gray-400'} flex items-center justify-center text-xl transition-colors">
                                <i class="fas ${due > 0 ? 'fa-book-open' : 'fa-check'}"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-white text-lg">${deck.name}</h3>
                                <p class="text-xs text-gray-400">${deck.cards.length} ‡∏Å‡∏≤‡∏£‡πå‡∏î ${due > 0 ? `<span class="text-indigo-300 bg-indigo-900/50 px-1.5 py-0.5 rounded ml-1 font-bold">‚Ä¢ ‡∏£‡∏≠ ${due}</span>` : ''}</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-600"></i>
                    `;
                    list.appendChild(div);
                });
            }
        }

        function createNewDeck() {
            const name = prompt("‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ Deck ‡πÉ‡∏´‡∏°‡πà:");
            if(name) {
                library.push({ id: Date.now(), name: name, cards: [] });
                saveData(); renderLibrary();
            }
        }
        
        function openDeck(id) {
            activeDeckId = id;
            const deck = library.find(d => d.id === id);
            
            document.getElementById('screen-library').classList.add('hidden');
            document.getElementById('screen-dashboard').classList.remove('hidden');
            document.getElementById('btn-back').classList.remove('hidden');
            document.getElementById('header-title').innerText = deck.name;
            document.getElementById('header-subtitle').innerText = "Dashboard";
            
            updateDashboard();
        }

        function closeDashboard() { 
            activeDeckId = null;
            document.getElementById('screen-dashboard').classList.add('hidden');
            document.getElementById('screen-study').classList.add('hidden');
            document.getElementById('screen-finished').classList.add('hidden');
            document.getElementById('screen-library').classList.remove('hidden');
            document.getElementById('btn-back').classList.add('hidden');
            document.getElementById('header-title').innerText = "Legendary Library";
            document.getElementById('header-subtitle').innerText = "V3.1 Flip Toggle";
            renderLibrary();
        }
        
        function deleteCurrentDeck() {
            if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö Deck ‡∏ô‡∏µ‡πâ? (‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)")) {
                library = library.filter(d => d.id !== activeDeckId);
                saveData(); closeDashboard();
            }
        }

        function goToLibrary() { closeDashboard(); }

        function updateDashboard() {
            const deck = library.find(d => d.id === activeDeckId);
            document.getElementById('dash-title').innerText = deck.name;
            const now = Date.now();
            const dueCount = deck.cards.filter(c => c.nextReview <= now).length;
            document.getElementById('dash-stats').innerText = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${deck.cards.length} ‡πÉ‡∏ö | ‡∏à‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ${deck.cards.filter(c => c.state === 'review').length} ‡πÉ‡∏ö`;
            
            const btn = document.getElementById('btn-play');
            const badge = document.getElementById('dash-badge');
            
            if(dueCount > 0) {
                btn.classList.remove('opacity-50', 'pointer-events-none');
                btn.innerHTML = `<i class="fas fa-play"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô (${dueCount})`;
                badge.classList.remove('hidden');
                badge.innerText = dueCount;
            } else {
                btn.classList.add('opacity-50', 'pointer-events-none');
                btn.innerHTML = `<i class="fas fa-check"></i> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô`;
                badge.classList.add('hidden');
            }
        }

        // --- 3. IMPORT LOGIC (SMART PASTE) ---
        function triggerImport() { document.getElementById('csvInput').click(); }
        function handleCSV(input) {
            const file = input.files[0]; if(!file) return;
            Papa.parse(file, { complete: function(results) {
                const deck = library.find(d => d.id === activeDeckId);
                let count = 0;
                results.data.forEach(row => {
                    if(row.length >= 2 && row[0]) { deck.cards.push(createCard(row[0], row[1])); count++; }
                });
                saveData(); updateDashboard(); alert(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${count} ‡πÉ‡∏ö ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà ${deck.name}`);
            }, header: false });
        }
        function openPasteModal() { document.getElementById('paste-modal').classList.remove('hidden'); }
        function processPaste() {
            const text = document.getElementById('paste-area').value; if(!text) return;
            const deck = library.find(d => d.id === activeDeckId);
            let count = 0;
            text.split('\n').forEach(line => {
                let parts = null;
                if(line.includes('\t')) parts = line.split('\t'); // Excel
                else if(line.includes(':')) parts = line.split(':');
                else if(line.includes('-')) parts = line.split('-');
                if(parts && parts.length >= 2) {
                    deck.cards.push(createCard(parts[0].trim(), parts.slice(1).join(':').trim()));
                    count++;
                }
            });
            saveData(); updateDashboard(); document.getElementById('paste-modal').classList.add('hidden');
            document.getElementById('paste-area').value = ""; alert(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${count} ‡πÉ‡∏ö ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`);
        }
        function createCard(front, back) {
            return { id: Date.now() + Math.random(), front: front, back: back, state: 'new', stepIndex: 0, nextReview: Date.now(), interval: 0, ease: 2.5, streak: 0 };
        }

        // --- 4. GAMEPLAY (THE FLIP TOGGLE LOGIC) ---
        function startSession() {
            const deck = library.find(d => d.id === activeDeckId);
            sessionQueue = deck.cards.filter(c => c.nextReview <= Date.now()).sort((a,b)=>a.nextReview - b.nextReview);
            if(sessionQueue.length === 0) return;
            document.getElementById('screen-dashboard').classList.add('hidden');
            document.getElementById('screen-study').classList.remove('hidden');
            loadNextCard();
        }

        function loadNextCard() {
            if(sessionQueue.length === 0) {
                document.getElementById('screen-study').classList.add('hidden');
                document.getElementById('screen-finished').classList.remove('hidden');
                return;
            }
            currentCard = sessionQueue[0];
            isFlipped = false; // Reset flip state
            
            // Render Content
            document.getElementById('card-front').innerText = currentCard.front;
            document.getElementById('card-back').innerText = currentCard.back;
            document.getElementById('card-streak').innerText = currentCard.streak;
            document.getElementById('queue-remain').innerText = sessionQueue.length;
            
            // Reset Visuals (Show Front)
            const cardInner = document.getElementById('card-inner');
            const controls = document.getElementById('controls');
            
            cardInner.style.transform = 'rotateY(0deg)';
            controls.classList.add('opacity-0', 'pointer-events-none');
            controls.classList.remove('opacity-100', 'pointer-events-auto');
            controls.classList.add('translate-y-4'); // Reset slide up animation
            
            updateLabels(); // Calculate future times
        }

        function toggleFlip() {
            isFlipped = !isFlipped; // Toggle State
            
            const cardInner = document.getElementById('card-inner');
            const controls = document.getElementById('controls');

            if (isFlipped) {
                // Show Back (Answer) & Show Controls
                cardInner.style.transform = 'rotateY(180deg)';
                controls.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-4');
                controls.classList.add('opacity-100', 'pointer-events-auto', 'translate-y-0');
            } else {
                // Show Front (Question) & Hide Controls
                cardInner.style.transform = 'rotateY(0deg)';
                controls.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');
                controls.classList.remove('opacity-100', 'pointer-events-auto', 'translate-y-0');
            }
        }

        // --- 5. ALGORITHM ENGINE (ADVANCED) ---
        function rateCard(rating) {
            const deck = library.find(d => d.id === activeDeckId);
            const cardRef = deck.cards.find(c => c.id === currentCard.id);
            const now = Date.now();
            const ONE_MIN = 60000; const ONE_DAY = 86400000;

            // Clone for calc
            let next = { ...cardRef };
            
            if (next.state === 'new' || next.state === 'learning') {
                if (rating === 1) { // Again
                    next.stepIndex = 0;
                    next.nextReview = now + (SETTINGS.LEARNING_STEPS[0] * ONE_MIN);
                } else if (rating === 2) { // Hard
                    next.nextReview = now + (SETTINGS.LEARNING_STEPS[next.stepIndex] * ONE_MIN * 1.5);
                } else if (rating === 3) { // Good
                    next.stepIndex++;
                    if (next.stepIndex >= SETTINGS.LEARNING_STEPS.length) {
                        next.state = 'review'; next.interval = SETTINGS.GRADUATING_INTERVAL; next.nextReview = now + (next.interval * ONE_DAY);
                    } else {
                        next.nextReview = now + (SETTINGS.LEARNING_STEPS[next.stepIndex] * ONE_MIN);
                    }
                } else if (rating === 4) { // Easy
                    next.state = 'review'; next.interval = 4; next.nextReview = now + (4 * ONE_DAY);
                }
            } else { // Review
                if (rating === 1) { // Lapse
                    next.state = 'learning'; next.stepIndex = 0; next.nextReview = now + (SETTINGS.LEARNING_STEPS[0] * ONE_MIN);
                    next.interval = Math.max(1, Math.round(next.interval * 0.5));
                    next.ease = Math.max(1.3, next.ease - 0.2);
                } else if (rating === 2) { // Hard
                    next.interval = Math.round(next.interval * 1.2);
                    next.ease = Math.max(1.3, next.ease - 0.15);
                    next.nextReview = now + (next.interval * ONE_DAY);
                } else if (rating === 3) { // Good
                    next.interval = Math.round(next.interval * next.ease);
                    next.nextReview = now + (next.interval * ONE_DAY);
                } else if (rating === 4) { // Easy
                    next.interval = Math.round(next.interval * next.ease * SETTINGS.EASY_BONUS);
                    next.ease += 0.15;
                    next.nextReview = now + (next.interval * ONE_DAY);
                }
                
                // Fuzzing (Randomize slightly)
                if (rating > 1 && next.state === 'review') {
                    const fuzz = Math.max(1, Math.round(next.interval * SETTINGS.FUZZ_FACTOR));
                    const shift = Math.floor(Math.random() * (fuzz * 2 + 1)) - fuzz;
                    next.nextReview += (shift * ONE_DAY);
                }
            }

            // Save changes
            Object.assign(cardRef, next);
            saveData();

            // Queue Management
            sessionQueue.shift();
            if (cardRef.nextReview <= now + (10 * ONE_MIN)) {
                // Re-queue if due soon (Relearning)
                sessionQueue.push(cardRef);
                sessionQueue.sort((a,b) => a.nextReview - b.nextReview);
            }
            loadNextCard();
        }

        function updateLabels() {
            // Simplified for performance in JS loop
            const times = ['1m', '2d', '3d', '4d']; // Placeholder
            // In real usage, we would pre-calculate these like in V2.5
        }

        function saveData() { localStorage.setItem('legendaryLibrary', JSON.stringify(library)); }
        function resetAllData() { if(confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å Deck?")) { localStorage.removeItem('legendaryLibrary'); location.reload(); } }
        
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>
