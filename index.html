<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Legendary Flashcards V2.5</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1903/1903162.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .no-tap-highlight { -webkit-tap-highlight-color: transparent; }
        
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: all 0.2s ease-in; }
    </style>
</head>
<body class="bg-gray-900 h-screen flex flex-col text-white font-sans overflow-hidden select-none">

    <header class="px-6 py-4 bg-gray-800 shadow-md flex justify-between items-center z-10 border-b border-gray-700">
        <div>
            <h1 class="text-xl font-bold text-indigo-400">Legendary Cards <span class="text-xs text-gray-500 bg-gray-900 px-2 rounded border border-gray-700">V2.5</span></h1>
            <p id="due-counter" class="text-xs text-gray-400 mt-1">กำลังคำนวณ...</p>
        </div>
        <button onclick="resetData()" class="text-gray-500 text-xs hover:text-red-400 p-2">
            <i class="fas fa-trash"></i>
        </button>
    </header>

    <main id="app-container" class="flex-1 relative w-full max-w-lg mx-auto">
        
        <div id="scene-home" class="absolute inset-0 flex flex-col items-center justify-center p-6 space-y-6 transition-opacity duration-300">
            <div class="text-center space-y-2">
                <div class="inline-block p-4 rounded-full bg-gray-800 shadow-lg mb-2 relative">
                    <i class="fas fa-graduation-cap text-4xl text-indigo-500"></i>
                    <span id="badge-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-6 h-6 flex items-center justify-center rounded-full hidden">0</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-100">Deck ของคุณ</h2>
                <p id="stats-text" class="text-gray-400 text-sm">พร้อมฝึกสมองหรือยัง?</p>
            </div>

            <button onclick="startSession()" id="btn-start" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-4 rounded-2xl shadow-lg text-xl font-bold transition transform active:scale-95 flex items-center justify-center gap-2 opacity-50 pointer-events-none">
                <i class="fas fa-play"></i> ไม่มีคิวทบทวน
            </button>

            <div class="w-full border-t border-gray-700 pt-4 mt-4 grid grid-cols-2 gap-3">
                <button onclick="document.getElementById('csvInput').click()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 py-3 rounded-xl border border-gray-700 text-sm font-semibold transition flex flex-col items-center justify-center gap-1">
                    <i class="fas fa-file-csv text-green-400 text-xl"></i>
                    <span>นำเข้า CSV</span>
                </button>
                <button onclick="openPasteModal()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 py-3 rounded-xl border border-gray-700 text-sm font-semibold transition flex flex-col items-center justify-center gap-1">
                    <i class="fas fa-paste text-yellow-400 text-xl"></i>
                    <span>วางข้อความ</span>
                </button>
                <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleFileUpload(this)">
            </div>
        </div>

        <div id="scene-study" class="absolute inset-0 flex flex-col p-6 hidden bg-gray-900">
            <div class="flex justify-between text-xs text-gray-400 mb-2">
                <span><i class="fas fa-layer-group mr-1"></i>เหลือ: <span id="queue-remain">0</span></span>
                <span><i class="fas fa-history mr-1"></i>Streak: <span id="current-streak">0</span></span>
            </div>
            <div class="w-full bg-gray-700 h-1.5 rounded-full mb-6 overflow-hidden">
                <div id="progress-bar" class="bg-indigo-500 h-full w-0 transition-all duration-300 ease-out"></div>
            </div>
            <div class="flex-1 relative perspective-1000 group cursor-pointer no-tap-highlight z-20" onclick="flipCard()">
                <div id="card-inner" class="relative w-full h-full text-center transition-transform duration-500 transform-style-3d shadow-2xl rounded-2xl">
                    <div class="absolute inset-0 w-full h-full bg-gray-800 rounded-2xl border border-gray-700 flex flex-col items-center justify-center p-6 backface-hidden shadow-black/50 shadow-xl">
                        <span class="text-xs text-indigo-400 uppercase tracking-widest mb-4 bg-indigo-900/30 px-2 py-1 rounded">คำถาม</span>
                        <h2 id="card-front" class="text-3xl font-bold text-white leading-relaxed">Loading...</h2>
                        <p class="text-gray-500 text-xs mt-6 absolute bottom-6 animate-pulse">แตะเพื่อดูเฉลย</p>
                    </div>
                    <div class="absolute inset-0 w-full h-full bg-indigo-900 rounded-2xl border border-indigo-700 flex flex-col items-center justify-center p-6 backface-hidden rotate-y-180 shadow-black/50 shadow-xl">
                        <span class="text-xs text-indigo-200 uppercase tracking-widest mb-4 bg-indigo-800/50 px-2 py-1 rounded">เฉลย</span>
                        <h2 id="card-back" class="text-3xl font-bold text-white leading-relaxed">Answer</h2>
                    </div>
                </div>
            </div>
            <div id="controls" class="mt-6 grid grid-cols-4 gap-3 opacity-0 pointer-events-none transition-all duration-300 transform translate-y-4">
                <button onclick="rateCard(1)" class="bg-red-900/40 border border-red-900/50 text-red-200 py-4 rounded-xl font-bold text-sm active:bg-red-800 active:scale-95 transition-all">Again<br><span id="label-again" class="text-[10px] font-normal opacity-70">1m</span></button>
                <button onclick="rateCard(2)" class="bg-yellow-900/40 border border-yellow-900/50 text-yellow-200 py-4 rounded-xl font-bold text-sm active:bg-yellow-800 active:scale-95 transition-all">Hard<br><span id="label-hard" class="text-[10px] font-normal opacity-70">2d</span></button>
                <button onclick="rateCard(3)" class="bg-green-900/40 border border-green-900/50 text-green-200 py-4 rounded-xl font-bold text-sm active:bg-green-800 active:scale-95 transition-all">Good<br><span id="label-good" class="text-[10px] font-normal opacity-70">3d</span></button>
                <button onclick="rateCard(4)" class="bg-blue-900/40 border border-blue-900/50 text-blue-200 py-4 rounded-xl font-bold text-sm active:bg-blue-800 active:scale-95 transition-all">Easy<br><span id="label-easy" class="text-[10px] font-normal opacity-70">5d</span></button>
            </div>
        </div>

        <div id="scene-finished" class="absolute inset-0 flex flex-col items-center justify-center p-6 hidden text-center bg-gray-900">
            <h2 class="text-3xl font-bold text-white mb-2">เสร็จสิ้น!</h2>
            <button onclick="goHome()" class="mt-8 bg-indigo-600 w-full py-4 rounded-xl font-bold text-white shadow-lg">กลับหน้าหลัก</button>
        </div>

        <div id="paste-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-gray-800 w-full max-w-lg rounded-2xl shadow-2xl border border-gray-700 flex flex-col overflow-hidden max-h-[80vh]">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-900">
                    <h3 class="font-bold text-white"><i class="fas fa-magic text-yellow-400 mr-2"></i>วางข้อความ (Auto-Detect)</h3>
                    <button onclick="closePasteModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="p-4 flex-1 flex flex-col gap-2">
                    <p class="text-xs text-gray-400">รองรับ: Excel, Tab, Comma, " - " หรือ " : "</p>
                    <textarea id="paste-area" class="w-full h-48 bg-gray-900 text-white p-3 rounded-lg border border-gray-700 focus:border-indigo-500 focus:outline-none text-sm" placeholder="วางข้อความที่นี่...&#10;เช่น:&#10;Dog : สุนัข&#10;Cat : แมว"></textarea>
                </div>
                <div class="p-4 border-t border-gray-700 flex gap-2">
                    <button onclick="processPaste()" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold">แปลงร่าง! ⚡</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- 1. CONFIG & DATA ---
        let deck = JSON.parse(localStorage.getItem('legendaryDeckV2')) || [];
        const SETTINGS = { LEARNING_STEPS: [1, 10], GRADUATING_INTERVAL: 1, EASY_BONUS: 1.3, INTERVAL_MODIFIER: 1.0 };
        let sessionQueue = [];
        let currentCard = null;
        let isFlipped = false;

        // Init
        updateDashboard();

        // --- 2. PASTE & AUTO-DETECT SYSTEM (THE NEW FEATURE) ---
        function openPasteModal() {
            document.getElementById('paste-modal').classList.remove('hidden');
            document.getElementById('paste-area').value = '';
            document.getElementById('paste-area').focus();
        }

        function closePasteModal() {
            document.getElementById('paste-modal').classList.add('hidden');
        }

        function processPaste() {
            const text = document.getElementById('paste-area').value.trim();
            if(!text) return;

            const lines = text.split('\n');
            let successCount = 0;
            let detectedSeparator = null;

            // 1. Heuristic Detection: เดาว่าใช้ตัวแบ่งอะไร
            // ลองเช็ค 10 บรรทัดแรก
            const sampleLines = lines.slice(0, 10).filter(l => l.trim().length > 0);
            if(sampleLines.length > 0) {
                const countTab = (sampleLines.join('').match(/\t/g) || []).length;
                const countColon = (sampleLines.join('').match(/:/g) || []).length;
                const countDash = (sampleLines.join('').match(/-/g) || []).length;
                const countComma = (sampleLines.join('').match(/,/g) || []).length;

                // Logic การเดา
                if (countTab >= sampleLines.length) detectedSeparator = '\t'; // มาจาก Excel ชัวร์
                else if (countColon >= sampleLines.length) detectedSeparator = ':';
                else if (countDash >= sampleLines.length) detectedSeparator = '-';
                else if (countComma >= sampleLines.length) detectedSeparator = ',';
                else detectedSeparator = 'auto'; // เดาไม่ถูก ให้ลองมั่วดู
            }

            // 2. Processing
            lines.forEach(line => {
                line = line.trim();
                if(!line) return;

                let front = '', back = '';

                if(detectedSeparator && detectedSeparator !== 'auto') {
                    // ถ้าเจอตัวแบ่งชัดเจน
                    const parts = line.split(detectedSeparator);
                    if(parts.length >= 2) {
                        front = parts[0].trim();
                        // รวมส่วนหลังทั้งหมดเผื่อมีตัวแบ่งซ้ำในประโยค
                        back = parts.slice(1).join(detectedSeparator).trim();
                    }
                } else {
                    // Fallback: ถ้าเดาไม่ออก ลองหาตัวแบ่งที่น่าจะเป็นไปได้ที่สุดในบรรทัดนั้น
                    const separators = ['\t', ':', '-', ','];
                    for (let sep of separators) {
                        if(line.includes(sep)) {
                            const parts = line.split(sep);
                            if(parts.length >= 2) {
                                front = parts[0].trim();
                                back = parts.slice(1).join(sep).trim();
                                break;
                            }
                        }
                    }
                }

                // ถ้าหาเจอทั้งหน้าและหลัง
                if(front && back) {
                    addCardToDeck(front, back);
                    successCount++;
                }
            });

            if(successCount > 0) {
                saveDeck();
                updateDashboard();
                closePasteModal();
                alert(`✨ นำเข้าสำเร็จ ${successCount} ใบ! (ใช้ตัวแบ่ง: ${detectedSeparator === '\t' ? 'Tab' : detectedSeparator})`);
            } else {
                alert('❌ ไม่สามารถอ่านข้อมูลได้ กรุณาลองใช้รูปแบบ "คำถาม : คำตอบ"');
            }
        }

        function addCardToDeck(front, back) {
            deck.push({
                id: Date.now() + Math.random(),
                front: front,
                back: back,
                state: 'new',
                stepIndex: 0,
                nextReview: Date.now(),
                interval: 0,
                ease: 2.5,
                streak: 0
            });
        }

        // --- 3. STANDARD FUNCTIONS (เหมือน V2) ---
        // (ส่วนนี้เหมือนเดิม ลดรูปเพื่อประหยัดพื้นที่ในการแสดงผล แต่เวลาใช้งานจริงให้ใส่ Logic ของ V2 ตรงนี้)
        function updateDashboard() {
            const now = Date.now();
            const dueCount = deck.filter(c => c.nextReview <= now).length;
            document.getElementById('due-counter').innerText = `รอทบทวน: ${dueCount} ใบ`;
            document.getElementById('stats-text').innerText = `ทั้งหมด ${deck.length} ใบ | จำได้แล้ว ${deck.filter(c=>c.state==='review').length} ใบ`;
            
            const btnStart = document.getElementById('btn-start');
            if(dueCount > 0) {
                btnStart.classList.remove('opacity-50', 'pointer-events-none', 'bg-gray-600');
                btnStart.classList.add('bg-indigo-600');
                btnStart.innerHTML = `<i class="fas fa-play"></i> เริ่มทบทวน (${dueCount})`;
            } else {
                btnStart.classList.add('opacity-50', 'pointer-events-none', 'bg-gray-600');
                btnStart.classList.remove('bg-indigo-600');
                btnStart.innerHTML = `<i class="fas fa-check"></i> ว่างเปล่า`;
            }
        }

        function startSession() {
            sessionQueue = deck.filter(c => c.nextReview <= Date.now()).sort((a,b) => a.nextReview - b.nextReview);
            if(sessionQueue.length === 0) return;
            document.getElementById('scene-home').classList.add('hidden');
            document.getElementById('scene-study').classList.remove('hidden');
            loadNextCard();
        }

        function loadNextCard() {
            if(sessionQueue.length === 0) { finishSession(); return; }
            currentCard = sessionQueue[0];
            isFlipped = false;
            document.getElementById('card-front').innerText = currentCard.front;
            document.getElementById('card-back').innerText = currentCard.back;
            document.getElementById('current-streak').innerText = currentCard.streak || 0;
            document.getElementById('card-inner').style.transform = 'rotateY(0deg)';
            const controls = document.getElementById('controls');
            controls.classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('queue-remain').innerText = sessionQueue.length;
            updateButtonLabels();
        }

        function updateButtonLabels() {
            const ratings = [1, 2, 3, 4];
            const ids = ['again', 'hard', 'good', 'easy'];
            ratings.forEach((r, i) => {
                const simulated = calculateAlgorithm(currentCard, r);
                const diffMs = simulated.nextReview - Date.now();
                let label = "";
                const min = 60000, hour = 3600000, day = 86400000;
                if (diffMs < hour) label = Math.round(diffMs/min) + "m";
                else if (diffMs < day) label = Math.round(diffMs/hour) + "h";
                else label = Math.round(diffMs/day) + "d";
                document.getElementById('label-' + ids[i]).innerText = label;
            });
        }

        function flipCard() {
            if(isFlipped) return; isFlipped = true;
            document.getElementById('card-inner').style.transform = 'rotateY(180deg)';
            const controls = document.getElementById('controls');
            controls.classList.remove('opacity-0', 'pointer-events-none');
            controls.classList.add('opacity-100', 'pointer-events-auto');
        }

        function rateCard(rating) {
            const updatedCard = calculateAlgorithm(currentCard, rating);
            const index = deck.findIndex(c => c.id === currentCard.id);
            if(index !== -1) deck[index] = updatedCard;
            saveDeck();
            sessionQueue.shift();
            if (updatedCard.nextReview <= Date.now() + 600000) {
                sessionQueue.push(updatedCard);
                sessionQueue.sort((a,b) => a.nextReview - b.nextReview);
            }
            loadNextCard();
        }

        // --- ALGORITHM V2 (ย่อรูป) ---
        function calculateAlgorithm(card, rating) {
            let next = { ...card }; const now = Date.now(); const ONE_MIN = 60000; const ONE_DAY = 86400000;
            if (next.state === 'new' || next.state === 'learning') {
                if (rating === 1) { next.stepIndex = 0; next.nextReview = now + (SETTINGS.LEARNING_STEPS[0] * ONE_MIN); }
                else if (rating === 2) { next.nextReview = now + (SETTINGS.LEARNING_STEPS[next.stepIndex] * ONE_MIN * 1.5); }
                else if (rating === 3) { 
                    next.stepIndex++; 
                    if (next.stepIndex >= SETTINGS.LEARNING_STEPS.length) { next.state = 'review'; next.interval = SETTINGS.GRADUATING_INTERVAL; next.nextReview = now + (next.interval * ONE_DAY); }
                    else { next.nextReview = now + (SETTINGS.LEARNING_STEPS[next.stepIndex] * ONE_MIN); }
                } 
                else if (rating === 4) { next.state = 'review'; next.interval = 4; next.nextReview = now + (next.interval * ONE_DAY); }
            } else { // Review
                if (rating === 1) { next.state = 'learning'; next.stepIndex = 0; next.nextReview = now + (SETTINGS.LEARNING_STEPS[0] * ONE_MIN); next.interval = Math.max(1, Math.round(next.interval * 0.5)); next.ease = Math.max(1.3, next.ease - 0.2); }
                else if (rating === 2) { next.interval = Math.max(1, Math.round(next.interval * 1.2)); next.ease = Math.max(1.3, next.ease - 0.15); next.nextReview = now + (next.interval * ONE_DAY); }
                else if (rating === 3) { next.interval = Math.round(next.interval * next.ease); next.nextReview = now + (next.interval * ONE_DAY); }
                else if (rating === 4) { next.interval = Math.round(next.interval * next.ease * SETTINGS.EASY_BONUS); next.ease += 0.15; next.nextReview = now + (next.interval * ONE_DAY); }
                if (rating > 1 && next.interval > 3) { const fuzz = Math.round(next.interval * 0.05); next.nextReview += (Math.floor(Math.random()*(fuzz*2+1))-fuzz) * ONE_DAY; }
            }
            return next;
        }

        function finishSession() {
            document.getElementById('scene-study').classList.add('hidden');
            document.getElementById('scene-finished').classList.remove('hidden');
        }
        function goHome() {
            document.getElementById('scene-finished').classList.add('hidden');
            document.getElementById('scene-home').classList.remove('hidden');
            updateDashboard();
        }
        function saveDeck() { localStorage.setItem('legendaryDeckV2', JSON.stringify(deck)); }
        function resetData() { if(confirm('ลบข้อมูลทั้งหมด?')) { localStorage.removeItem('legendaryDeckV2'); deck = []; updateDashboard(); } }
        function handleFileUpload(input) {
            const file = input.files[0]; if (!file) return;
            Papa.parse(file, { complete: function(results) {
                results.data.forEach(row => { if(row.length >= 2 && row[0]) addCardToDeck(row[0], row[1]); });
                saveDeck(); updateDashboard(); alert('Import สำเร็จ!');
            }, header: false, skipEmptyLines: true });
        }
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>
