<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Legendary Flashcards</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1903/1903162.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Card Flip Animation */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .no-tap-highlight { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-900 h-screen flex flex-col text-white font-sans overflow-hidden select-none">

    <header class="px-6 py-4 bg-gray-800 shadow-md flex justify-between items-center z-10">
        <div>
            <h1 class="text-xl font-bold text-indigo-400">Legendary Cards</h1>
            <p id="due-counter" class="text-xs text-gray-400">รอทบทวน: 0 ใบ</p>
        </div>
        <button onclick="resetData()" class="text-gray-500 text-xs hover:text-red-400">
            <i class="fas fa-trash"></i> Reset
        </button>
    </header>

    <main id="app-container" class="flex-1 relative w-full max-w-lg mx-auto">
        
        <div id="scene-home" class="absolute inset-0 flex flex-col items-center justify-center p-6 space-y-6 transition-opacity duration-300">
            <div class="text-center space-y-2">
                <div class="inline-block p-4 rounded-full bg-gray-800 shadow-lg mb-2">
                    <i class="fas fa-brain text-4xl text-indigo-500"></i>
                </div>
                <h2 class="text-2xl font-bold">พร้อมฝึกสมองไหม?</h2>
                <p class="text-gray-400 text-sm">ระบบ Spaced Repetition พร้อมใช้งาน</p>
            </div>

            <button onclick="startSession()" id="btn-start" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-4 rounded-2xl shadow-lg text-xl font-bold transition transform active:scale-95 flex items-center justify-center gap-2">
                <i class="fas fa-play"></i> เริ่มทบทวน
            </button>

            <div class="w-full border-t border-gray-700 pt-4">
                <button onclick="document.getElementById('csvInput').click()" class="w-full bg-gray-800 hover:bg-gray-700 text-gray-300 py-3 rounded-xl border border-gray-700 text-sm font-semibold transition">
                    <i class="fas fa-file-import mr-2"></i> นำเข้าการ์ดใหม่ (CSV)
                </button>
                <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleFileUpload(this)">
            </div>
        </div>

        <div id="scene-study" class="absolute inset-0 flex flex-col p-6 hidden">
            <div class="w-full bg-gray-700 h-1 rounded-full mb-6">
                <div id="progress-bar" class="bg-indigo-500 h-1 rounded-full w-0 transition-all duration-300"></div>
            </div>

            <div class="flex-1 relative perspective-1000 group cursor-pointer no-tap-highlight" onclick="flipCard()">
                <div id="card-inner" class="relative w-full h-full text-center transition-transform duration-500 transform-style-3d shadow-2xl rounded-2xl">
                    
                    <div class="absolute inset-0 w-full h-full bg-gray-800 rounded-2xl border-2 border-indigo-900 flex flex-col items-center justify-center p-6 backface-hidden">
                        <span class="text-xs text-indigo-400 uppercase tracking-widest mb-2">คำถาม</span>
                        <h2 id="card-front" class="text-3xl font-bold text-white leading-relaxed">...</h2>
                        <p class="text-gray-500 text-xs mt-4 absolute bottom-6">แตะเพื่อดูเฉลย</p>
                    </div>

                    <div class="absolute inset-0 w-full h-full bg-indigo-900 rounded-2xl border-2 border-indigo-700 flex flex-col items-center justify-center p-6 backface-hidden rotate-y-180">
                        <span class="text-xs text-indigo-300 uppercase tracking-widest mb-2">เฉลย</span>
                        <h2 id="card-back" class="text-3xl font-bold text-white leading-relaxed">...</h2>
                    </div>
                </div>
            </div>

            <div id="controls" class="mt-6 grid grid-cols-4 gap-2 opacity-0 pointer-events-none transition-opacity duration-300">
                <button onclick="rateCard(1)" class="bg-red-900/80 text-red-200 py-3 rounded-lg font-bold text-sm active:scale-95">Again<br><span class="text-xs font-normal opacity-70">1m</span></button>
                <button onclick="rateCard(2)" class="bg-yellow-900/80 text-yellow-200 py-3 rounded-lg font-bold text-sm active:scale-95">Hard<br><span class="text-xs font-normal opacity-70">2d</span></button>
                <button onclick="rateCard(3)" class="bg-green-900/80 text-green-200 py-3 rounded-lg font-bold text-sm active:scale-95">Good<br><span class="text-xs font-normal opacity-70">4d</span></button>
                <button onclick="rateCard(4)" class="bg-blue-900/80 text-blue-200 py-3 rounded-lg font-bold text-sm active:scale-95">Easy<br><span class="text-xs font-normal opacity-70">7d</span></button>
            </div>
        </div>

        <div id="scene-finished" class="absolute inset-0 flex flex-col items-center justify-center p-6 hidden text-center">
            <i class="fas fa-check-circle text-6xl text-green-500 mb-4 animate-bounce"></i>
            <h2 class="text-3xl font-bold text-white">ยอดเยี่ยม!</h2>
            <p class="text-gray-400 mt-2">คุณทบทวนครบทุกใบแล้ว</p>
            <p class="text-gray-500 text-sm mt-8">กลับมาใหม่พรุ่งนี้นะ</p>
            <button onclick="goHome()" class="mt-8 bg-gray-700 px-6 py-3 rounded-full text-white">กลับหน้าหลัก</button>
        </div>

    </main>

    <script>
        // --- 1. DATA & STATE MANAGEMENT ---
        let deck = JSON.parse(localStorage.getItem('legendaryDeck')) || [];
        let sessionQueue = [];
        let currentCard = null;
        let isFlipped = false;

        // อัปเดตหน้าจอเมื่อเปิดแอป
        updateDashboard();

        // --- 2. CSV IMPORT SYSTEM ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            Papa.parse(file, {
                complete: function(results) {
                    let newCards = 0;
                    results.data.forEach(row => {
                        if(row.length >= 2 && row[0]) {
                            // สร้าง Card Object ใหม่
                            deck.push({
                                id: Date.now() + Math.random(),
                                front: row[0],
                                back: row[1],
                                nextReview: Date.now(), // พร้อมเรียนทันที
                                interval: 0,
                                ease: 2.5, // ค่ามาตรฐาน SM-2
                                streak: 0
                            });
                            newCards++;
                        }
                    });
                    saveDeck();
                    alert(`นำเข้าสำเร็จ ${newCards} ใบ!`);
                    updateDashboard();
                },
                header: false,
                skipEmptyLines: true
            });
        }

        function saveDeck() {
            localStorage.setItem('legendaryDeck', JSON.stringify(deck));
        }

        function resetData() {
            if(confirm('ลบข้อมูลการ์ดทั้งหมด?')) {
                localStorage.removeItem('legendaryDeck');
                deck = [];
                updateDashboard();
            }
        }

        // --- 3. SPACED REPETITION ENGINE (SM-2 Algorithm) ---
        function calculateNextReview(card, quality) {
            // Quality: 1=Again, 2=Hard, 3=Good, 4=Easy
            
            if (quality === 1) {
                card.streak = 0;
                card.interval = 1; // 1 วัน (หรือจริงๆ ควรเป็นนาทีแต่เพื่อให้ง่ายเอาเป็น 1 วันก่อน)
            } else {
                // สูตร SM-2
                if (card.streak === 0) card.interval = 1;
                else if (card.streak === 1) card.interval = 6;
                else card.interval = Math.round(card.interval * card.ease);
                
                card.streak++;
                // ปรับ Ease Factor
                card.ease = card.ease + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                if (card.ease < 1.3) card.ease = 1.3;
            }

            // ตั้งเวลา Review ครั้งหน้า (มิลลิวินาที)
            // หมายเหตุ: เพื่อการทดสอบ ให้หน่วยเป็น "นาที" แทน "วัน" ในโค้ดจริงให้เปลี่ยน 60000 เป็น 86400000 (24ชม)
            // แต่เพื่อให้เห็นผลใน Demo นี้ ผมจะใช้หน่วยเป็น "วินาที * ตัวคูณ"
            // *** โหมด Production: เปลี่ยนตัวคูณด้านล่างเป็น 24 * 60 * 60 * 1000 ***
            const ONE_DAY_MS = 24 * 60 * 60 * 1000; 
            card.nextReview = Date.now() + (card.interval * ONE_DAY_MS);
            
            return card;
        }

        // --- 4. GAMEPLAY LOGIC ---
        function updateDashboard() {
            const now = Date.now();
            const dueCount = deck.filter(c => c.nextReview <= now).length;
            
            document.getElementById('due-counter').innerText = `รอทบทวน: ${dueCount} ใบ`;
            
            const btnStart = document.getElementById('btn-start');
            if(dueCount > 0) {
                btnStart.classList.remove('opacity-50', 'pointer-events-none');
                btnStart.innerHTML = `<i class="fas fa-play"></i> เริ่มทบทวน (${dueCount})`;
            } else {
                btnStart.classList.add('opacity-50', 'pointer-events-none');
                btnStart.innerHTML = `<i class="fas fa-check"></i> ว่างเปล่า`;
            }
        }

        function startSession() {
            const now = Date.now();
            sessionQueue = deck.filter(c => c.nextReview <= now);
            if(sessionQueue.length === 0) return;

            document.getElementById('scene-home').classList.add('hidden');
            document.getElementById('scene-study').classList.remove('hidden');
            loadNextCard();
        }

        function loadNextCard() {
            if(sessionQueue.length === 0) {
                finishSession();
                return;
            }

            currentCard = sessionQueue[0];
            isFlipped = false;
            
            // Render Card
            document.getElementById('card-front').innerText = currentCard.front;
            document.getElementById('card-back').innerText = currentCard.back;
            
            // Reset UI
            const cardInner = document.getElementById('card-inner');
            cardInner.style.transform = 'rotateY(0deg)';
            
            const controls = document.getElementById('controls');
            controls.classList.add('opacity-0', 'pointer-events-none');
            
            // Update Progress
            const total = deck.filter(c => c.nextReview <= Date.now()).length + sessionQueue.length; // ประมาณการ
            // (ในที่นี้ทำ Progress Bar แบบง่ายๆ)
        }

        function flipCard() {
            if(isFlipped) return; // พลิกแล้วห้ามพลิกกลับ
            isFlipped = true;
            
            document.getElementById('card-inner').style.transform = 'rotateY(180deg)';
            
            // Show Controls
            const controls = document.getElementById('controls');
            controls.classList.remove('opacity-0', 'pointer-events-none');
        }

        function rateCard(quality) {
            // คำนวณวันถัดไป
            calculateNextReview(currentCard, quality);
            
            // บันทึก
            // หา Index ของการ์ดใบนี้ใน Deck หลักแล้วอัปเดต
            const index = deck.findIndex(c => c.id === currentCard.id);
            if(index !== -1) deck[index] = currentCard;
            saveDeck();

            // เอาออกจากคิวปัจจุบัน
            sessionQueue.shift();
            
            // โหลดใบต่อไป
            loadNextCard();
        }

        function finishSession() {
            document.getElementById('scene-study').classList.add('hidden');
            document.getElementById('scene-finished').classList.remove('hidden');
            updateDashboard();
        }

        function goHome() {
            document.getElementById('scene-finished').classList.add('hidden');
            document.getElementById('scene-home').classList.remove('hidden');
        }

        // Service Worker (Keep existing)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }
    </script>
</body>
</html>
